name: CI/CD Pipeline
run-name: ${{ github.actor }} is running tests and deployment
on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
env:
  NODE_VERSION: '24'
  MONGODB_URI: mongodb://localhost:27017/cevra-test
  QDRANT_URL: http://localhost:6333
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
jobs:

  # API Tests Job
  api-tests:
    name: API Tests (Nest JS)
    runs-on: ubuntu-latest
    services:
      #MongoDB Service
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
          MONGO_INITDB_DATABASE: cevra-test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'" 
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      #Qdrant Service
      qdrant:
        image: qdrant/qdrant:v1.15.1
        ports:
          - 6333:6333
    
    steps: 
      # Checkout Repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: 'Setup Node.js ${{ env.NODE_VERSION }}'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'api/package.json'

      # Install API Dependencies
      - name: Install API dependencies
        working-directory: ./api
        run: npm ci

      # Wait for services to be ready
      - name: Wait for services
        run: |
          # Wait for MongoDB
          for i in {1..30}; do
            if mongosh --eval "db.adminCommand('ping')" --quiet; then
              echo "MongoDB is ready!"
              break
            fi
            echo "Waiting for MongoDB... ($i/30)"
            sleep 2
          done
          
          # Wait for Qdrant
          for i in {1..30}; do
            if curl -f http://localhost:6333/health >/dev/null 2>&1; then
              echo "Qdrant is ready!"
              break
            fi
            echo "Waiting for Qdrant... ($i/30)"
            sleep 2
          done
          
          echo "All services are ready!"

      # Run API Tests
      - name: Run ESLint on API
        working-directory: ./api
        run: npm run lint
      
      # Run Unit Tests
      - name: Run unit tests
        working-directory: ./api
        run: npm run test
      
      # Run E2E Tests
      - name: Run e2e tests
        working-directory: ./api
        run: npm run test:e2e

  # UI Tests Job
  ui-tests:
    name: UI Tests (Next.js)
    runs-on: ubuntu-latest
    steps:
      # Checkout Repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'ui/package.json'
      
      # Install UI Dependencies
      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci

      # Run ESLint
      - name: Run ESLint 
        working-directory: ./ui
        run: npm run lint
      
      # Build UI application
      - name: Build Next.js application
        working-directory: ./ui
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001

  # Security Audit Job
  security-audit:
    name: 'Security Audit'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Setup Node.js ${{ env.NODE_VERSION }}'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'Audit API dependencies'
        working-directory: ./api
        run: |
          npm ci
          npm audit --audit-level high

      - name: 'Audit UI dependencies'
        working-directory: ./ui
        run: |
          npm ci
          npm audit --audit-level high
  
  # Docker Build Tests
  docker-build:
    name: 'Docker Build Test'
    runs-on: ubuntu-latest
    needs: [api-tests, ui-tests, security-audit]
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      
      - name: 'Set up Docker Buildx'
        uses: docker/setup-buildx-action@v3
      
      - name: 'Build API Docker image'
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          target: production
          push: false
          tags: cevra-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 'Build UI Docker image'
        uses: docker/build-push-action@v5
        with:
          context: ./ui
          file: ./ui/Dockerfile
          target: production
          push: false
          tags: cevra-ui:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration Tests
  integration-tests:
    name: 'Integration Tests'
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Create test environment file'
        run: |
          cat > .env << EOF
          OPENAI_API_KEY=test-key-for-ci
          MONGODB_URI=mongodb://admin:password123@localhost:27017/cevra?authSource=admin
          QDRANT_URL=http://localhost:6333
          EOF

      - name: 'Run integration tests with Docker Compose'
        run: |
          docker-compose -f docker-compose.dev.yml up -d --build
          sleep 30  # Wait for services to be ready
          
          # Health checks
          curl -f http://localhost:3000 || exit 1
          curl -f http://localhost:3001 || exit 1
          
          # Cleanup
          docker-compose -f docker-compose.dev.yml down -v